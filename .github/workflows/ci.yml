name: CI - dbt Project

on:
  pull_request:
    branches:
      - main

jobs:
  dbt-ci:
    name: dbt CI Pipeline
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup do Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ InstalaÃ§Ã£o das dependÃªncias
      - name: Install Python dependencies
        run: |
          echo "ğŸ Installing dbt and SQLFluff dependencies"
          python -m pip install --upgrade pip
          pip install dbt-core dbt-databricks
          pip install sqlfluff sqlfluff-templater-dbt

      # 4ï¸âƒ£ SQLFluff Lint â€” com lista explÃ­cita de modelos
      - name: SQLFluff lint (dbt + Databricks)
        run: |
          echo "ğŸ” Running SQLFluff lint"
          echo "ğŸ“„ Config file: ci/sqlfluff/.sqlfluff"
          echo "ğŸ§  Dialect: Databricks"
          echo "ğŸ“‚ Models path: models/"
          echo ""

          sqlfluff lint models \
            --config ci/sqlfluff/.sqlfluff \
            --verbose \
            --format github-annotation \
            || (
              echo ""
              echo "âŒ SQLFluff validation FAILED"
              echo "ğŸ‘‰ One or more dbt models failed linting."
              echo "ğŸ‘‰ Check the list of files above in the logs."
              echo "ğŸ‘‰ GitHub annotations highlight the exact lines with issues."
              echo ""
              echo "ğŸ§  Common causes:"
              echo "   - Incorrect indentation"
              echo "   - Missing aliases"
              echo "   - Uppercase keywords (policy is lowercase)"
              echo ""
              exit 1
            )

      # 5ï¸âƒ£ dbt debug â€” valida estrutura do projeto
      - name: dbt debug (project validation)
        run: |
          echo "ğŸ§ª Running dbt debug"
          echo "ğŸ‘‰ Validating dbt_project.yml and dbt profile structure"
          echo ""

          dbt debug \
            --profiles-dir ~/.dbt \
            || (
              echo ""
              echo "âŒ dbt debug FAILED"
              echo "ğŸ‘‰ Check dbt_project.yml or profiles.yml configuration."
              echo "ğŸ‘‰ dbt project must be valid before merge."
              exit 1
            )
