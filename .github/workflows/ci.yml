name: CI - dbt Project

on:
  pull_request:
    branches:
      - main

jobs:
  dbt-ci:
    name: dbt CI Pipeline
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup do Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ InstalaÃ§Ã£o das dependÃªncias
      - name: Install Python dependencies
        run: |
          echo "ğŸ Installing dbt and SQLFluff dependencies"
          python -m pip install --upgrade pip
          pip install dbt-core dbt-databricks
          pip install sqlfluff sqlfluff-templater-dbt

      # 4ï¸âƒ£ SQLFluff Lint (com mensagens claras)
      - name: SQLFluff lint (dbt + Databricks)
        run: |
          echo "ğŸ” Running SQLFluff lint"
          echo "ğŸ“„ Config file: ci/sqlfluff/.sqlfluff"
          echo "ğŸ§  Dialect: Databricks"
          echo ""

          sqlfluff lint models \
            --config ci/sqlfluff/.sqlfluff \
            || (
              echo ""
              echo "âŒ SQLFluff validation FAILED"
              echo "ğŸ‘‰ One or more SQL files do not follow the project standards."
              echo "ğŸ‘‰ Please fix linting issues before merging."
              echo "ğŸ‘‰ Dialect expected: databricks"
              exit 1
            )

      # 5ï¸âƒ£ dbt debug (validaÃ§Ã£o de projeto)
      - name: dbt debug (project validation)
        run: |
          echo "ğŸ§ª Running dbt debug"
          echo "ğŸ‘‰ This validates dbt_project.yml and profiles.yml structure"
          echo ""

          dbt debug \
            --profiles-dir ~/.dbt \
            || (
              echo ""
              echo "âŒ dbt debug FAILED"
              echo "ğŸ‘‰ Check dbt_project.yml or profiles.yml configuration."
              echo "ğŸ‘‰ This project must be valid before merge."
              exit 1
            )
