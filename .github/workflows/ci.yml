name: CI - dbt Project

on:
  pull_request:
    branches:
      - main

jobs:
  dbt-ci:
    name: dbt CI Pipeline
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup do Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ Instalar dependÃªncias
      - name: Install Python dependencies
        run: |
          echo "ğŸ Installing dbt and SQLFluff"
          python -m pip install --upgrade pip
          pip install dbt-core dbt-databricks
          pip install sqlfluff sqlfluff-templater-dbt

      # 4ï¸âƒ£ Criar profiles.yml fake (somente para CI)
      - name: Create fake dbt profiles
        run: |
          echo "ğŸ§ª Creating fake dbt profiles for CI"
          mkdir -p /tmp/dbt_profiles
          cat <<EOF > /tmp/dbt_profiles/profiles.yml
          dbt_poseidon:
            target: ci
            outputs:
              ci:
                type: databricks
                host: fake
                http_path: fake
                token: fake
                catalog: fake
                schema: fake
                threads: 1
          EOF

      # 5ï¸âƒ£ SQLFluff lint â€” agora FUNCIONA e lista os modelos
      - name: SQLFluff lint (dbt + Databricks)
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          echo "ğŸ” Running SQLFluff lint"
          echo "ğŸ“„ Config: ci/sqlfluff/.sqlfluff"
          echo "ğŸ“‚ Models path: models/"
          echo "ğŸ“ dbt project dir: $GITHUB_WORKSPACE"
          echo ""

          sqlfluff lint models \
            --config ci/sqlfluff/.sqlfluff \
            --verbose \
            --format github-annotation \
            || (
              echo ""
              echo "âŒ SQLFluff validation FAILED"
              echo "ğŸ‘‰ One or more dbt models failed linting."
              echo "ğŸ‘‰ Check the list of files above."
              echo "ğŸ‘‰ GitHub annotations show exact lines."
              exit 1
            )

      # 6ï¸âƒ£ dbt debug â€” valida estrutura (sem conexÃ£o real)
      - name: dbt debug (structure validation)
        run: |
          echo "ğŸ§ª Running dbt debug"
          dbt debug \
            --profiles-dir /tmp/dbt_profiles \
            || (
              echo ""
              echo "âŒ dbt debug FAILED"
              echo "ğŸ‘‰ Check dbt_project.yml structure."
              exit 1
            )
