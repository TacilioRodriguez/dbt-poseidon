name: CI - dbt Project

on:
  pull_request:
    branches:
      - main

jobs:
  dbt-ci:
    name: dbt CI Pipeline
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup do Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ Instala dependÃªncias
      - name: Install Python dependencies
        run: |
          echo "ğŸ Installing dbt and SQLFluff"
          python -m pip install --upgrade pip
          pip install dbt-core dbt-databricks
          pip install sqlfluff sqlfluff-templater-dbt

      # 4ï¸âƒ£ Criar profiles.yml FAKE (apenas para CI)
      - name: Create fake dbt profiles for CI
        run: |
          echo "ğŸ§ª Creating fake dbt profiles for CI"
          mkdir -p /tmp/dbt_profiles
          cat <<EOF > /tmp/dbt_profiles/profiles.yml
          dbt_poseidon:
            target: ci
            outputs:
              ci:
                type: databricks
                host: fake
                http_path: fake
                token: fake
                catalog: fake
                schema: fake
                threads: 1
          EOF

      # 5ï¸âƒ£ SQLFluff lint â€” agora lista os modelos corretamente
      - name: SQLFluff lint (dbt + Databricks)
        run: |
          echo "ğŸ” Running SQLFluff lint"
          echo "ğŸ“„ Config: ci/sqlfluff/.sqlfluff"
          echo "ğŸ“‚ Models path: models/"
          echo ""

          sqlfluff lint models \
            --config ci/sqlfluff/.sqlfluff \
            --verbose \
            --format github-annotation \
            || (
              echo ""
              echo "âŒ SQLFluff validation FAILED"
              echo "ğŸ‘‰ One or more dbt models failed linting."
              echo "ğŸ‘‰ Check the list of files above."
              echo "ğŸ‘‰ GitHub annotations show exact lines."
              exit 1
            )

      # 6ï¸âƒ£ dbt debug (estrutura apenas, sem conexÃ£o real)
      - name: dbt debug (structure only)
        run: |
          echo "ğŸ§ª Running dbt debug (no real connection)"
          dbt debug \
            --profiles-dir /tmp/dbt_profiles \
            || (
              echo ""
              echo "âŒ dbt debug FAILED"
              echo "ğŸ‘‰ Check dbt_project.yml structure."
              exit 1
            )
